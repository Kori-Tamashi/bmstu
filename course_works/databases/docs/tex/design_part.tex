\chapter{Конструкторская часть}

В этой части представляются требования к программе,

\section{Диаграмма прецендентов}

Диаграмма прецендентов представлена на рисунке~\ref{fig:use-case-diagram}.

\begin{figure}[h!]
	\centering
	\includegraphics[width=1\textwidth]{images/use-case-diagram.png}
	\caption{Диаграмма прецендентов} 
	\label{fig:use-case-diagram} 
\end{figure}

\section{Описание сущностей базы данных}

На основе данных, представленных в таблице~\ref{tbl:data-groups}, можно определить таблицы, которые должны быть включены в базу данных:
\begin{enumerate}
	\item locations -- таблица локаций;
	\item events -- таблица мероприятий;
	\item persons -- таблица участников мероприятий;
	\item days -- таблица дней мероприятий;
	\item menu -- таблица меню дней мероприятий;
	\item items -- таблица предметов меню;
	\item feedbacks -- таблица отзывов участников;
	\item users -- таблица пользователей.
\end{enumerate}

На основе информации о выбранной СУБД и ER-диаграммы на рисунке~\ref{fig:er-diagram} можно определить структуры столбцов, их типы и ограничения для каждой таблицы, которые представлены в таблицах~\ref{tbl:locations}-\ref{tbl:users}.

\begin{table}[h!]
	\centering
	\caption{Информация о таблице локаций}
	\begin{tabularx}{\textwidth}{|p{2.6cm}|X|p{6cm}|X|}
		\hline
		\textbf{Атрибут} & \textbf{Тип данных} & \textbf{Ограничения} & \textbf{Сведение} \\
		\hline
		location\_id & UUID & NOT~NULL, \newline PRIMARY~KEY & Идентификатор локации \\
		\hline
		name & VARCHAR(255) & NOT~NULL & Название \\
		\hline
		description & TEXT & NOT~NULL & Описание \\
		\hline
		price & NUMERIC & NOT~NULL, \newline CHECK~(price~>=~0) & Цена аренды на 1 день \\
		\hline
		capacity & INT & NOT~NULL, \newline CHECK~(capacity~>=~0) & Вместимость \\
		\hline
	\end{tabularx}
	\label{tbl:locations}
\end{table}

\begin{table}[h!]
	\centering
	\caption{Информация о таблице мероприятий}
	\begin{tabularx}{\textwidth}{|p{2.6cm}|X|p{6cm}|X|}
		\hline
		\textbf{Атрибут} & \textbf{Тип данных} & \textbf{Ограничения} & \textbf{Сведение} \\
		\hline
		event\_id & UUID & NOT~NULL, \newline PRIMARY~KEY & Идентификатор мероприятия \\
		\hline
		name & VARCHAR(255) & NOT~NULL & Название \\
		\hline
		description & TEXT & NOT~NULL & Описание \\
		\hline
		date & DATE & NOT~NULL & Дата \\
		\hline
		person\_count & INT & NOT~NULL, \newline CHECK~(person\_count~>=~0) & Количество участников \\
		\hline
		days\_count & INT & NOT~NULL, \newline CHECK~(days\_count~>~0) & Количество дней \\
		\hline
		percent & NUMERIC & NOT~NULL, \newline CHECK~(percent~>=~0) & Наценка на посещение в процентах \\
		\hline
		rating & NUMERIC & NOT~NULL, \newline CHECK (rating~BETWEEN~0~AND~10) & Рейтинг \\
		\hline
	\end{tabularx}
	\label{tbl:events}
\end{table}

\begin{table}[h!]
	\centering
	\caption{Информация о таблице дней мероприятий}
	\begin{tabularx}{\textwidth}{|p{2.6cm}|X|p{6cm}|X|}
		\hline
		\textbf{Атрибут} & \textbf{Тип данных} & \textbf{Ограничения} & \textbf{Сведение} \\
		\hline
		day\_id & UUID & NOT~NULL, \newline PRIMARY~KEY & Идентификатор дня мероприятия \\
		\hline
		name & VARCHAR(255) & NOT~NULL & Название \\
		\hline
		sequence\_ number & INT & NOT~NULL, \newline CHECK (sequence\_number~>~0) & Порядковый номер \\
		\hline
		description & TEXT & NOT~NULL & Описание \\
		\hline
		price & NUMERIC & NOT~NULL, \newline CHECK~(price~>=~0) & Цена посещения \\
		\hline
	\end{tabularx}
	\label{tbl:days}
\end{table}

\begin{table}[h!]
	\centering
	\caption{Информация о таблице участников мероприятий}
	\begin{tabularx}{\textwidth}{|p{2.6cm}|X|p{6cm}|X|}
		\hline
		\textbf{Атрибут} & \textbf{Тип данных} & \textbf{Ограничения} & \textbf{Сведение} \\
		\hline
		person\_id & UUID & NOT~NULL, \newline PRIMARY~KEY & Идентификатор участника \\
		\hline
		name & VARCHAR(255) & NOT~NULL & Имя \\
		\hline
		type & ENUM & NOT~NULL & Тип \\
		\hline
		paid & BOOL & NOT~NULL & Факт оплаты \\
		\hline
	\end{tabularx}
	\label{tbl:persons}
\end{table}

\begin{table}[h!]
	\centering
	\caption{Информация о таблице меню дней мероприятий}
	\begin{tabularx}{\textwidth}{|p{2.6cm}|X|p{6cm}|X|}
		\hline
		\textbf{Атрибут} & \textbf{Тип данных} & \textbf{Ограничения} & \textbf{Сведение} \\
		\hline
		menu\_id & UUID & NOT~NULL, \newline PRIMARY~KEY & Идентификатор меню \\
		\hline
		name & VARCHAR(255) & NOT~NULL & Название \\
		\hline
		cost & NUMERIC & NOT~NULL, \newline CHECK~(cost~>=~0) & Стоимость \\
		\hline
	\end{tabularx}
	\label{tbl:menu}
\end{table}

\begin{table}[h!]
	\centering
	\caption{Информация о таблице предметов меню}
	\begin{tabularx}{\textwidth}{|p{2.6cm}|X|p{6cm}|X|}
		\hline
		\textbf{Атрибут} & \textbf{Тип данных} & \textbf{Ограничения} & \textbf{Сведение} \\
		\hline
		item\_id & UUID & NOT~NULL, \newline PRIMARY~KEY & Идентификатор предмета \\
		\hline
		name & VARCHAR(255) & NOT~NULL & Название \\
		\hline
		type & ENUM & NOT~NULL & Тип \\
		\hline
		price & NUMERIC & NOT~NULL, \newline CHECK~(price~>=~0) & Цена \\
		\hline
	\end{tabularx}
	\label{tbl:items}
\end{table}

\begin{table}[h!]
	\centering
	\caption{Информация о таблице отзывов}
	\begin{tabularx}{\textwidth}{|p{2.6cm}|X|p{6cm}|X|}
		\hline
		\textbf{Атрибут} & \textbf{Тип данных} & \textbf{Ограничения} & \textbf{Сведение} \\
		\hline
		feedback\_id & UUID & NOT~NULL, \newline PRIMARY~KEY & Идентификатор отзыва \\
		\hline
		event\_id & UUID & NOT~NULL, \newline FOREIGN~KEY & Идентификатор мероприятия \\
		\hline
		person\_id & UUID & NOT~NULL, \newline FOREIGN~KEY & Идентификатор участника \\
		\hline
		comment & TEXT & NOT~NULL & Комментарий \\
		\hline
		rating & NUMERIC & NOT~NULL, \newline CHECK (rating~BETWEEN~0~AND~10) & Рейтинг \\
		\hline
	\end{tabularx}
	\label{tbl:feedbacks}
\end{table}

\begin{table}[h!]
	\centering
	\caption{Информация о таблице пользователей}
	\begin{tabularx}{\textwidth}{|p{2.6cm}|X|p{6cm}|X|}
		\hline
		\textbf{Атрибут} & \textbf{Тип данных} & \textbf{Ограничения} & \textbf{Сведение} \\
		\hline
		user\_id & UUID & NOT~NULL, \newline PRIMARY~KEY & Идентификатор пользователя \\
		\hline
		phone & VARCHAR(255) & NOT~NULL & Телефон \\
		\hline
		gender & ENUM & NOT~NULL & Гендер \\
		\hline
		password & VARCHAR(255) & NOT~NULL & Пароль \\
		\hline
		role & ENUM & NOT~NULL & Роль \\
		\hline
	\end{tabularx}
	\label{tbl:users}
\end{table}

\newpage

Диаграмма базы данных представлена на рисунке~\ref{fig:db-diagram}.

\begin{figure}[h!]
	\centering
	\includegraphics[width=1\textwidth]{images/db-diagram.png}
	\caption{Диаграмма базы данных} 
	\label{fig:db-diagram} 
\end{figure}

\section{Ролевая модель}

Ролевая модель в СУБД распределяет права доступа между ролями, ограничивая их действия для обеспечения безопасности:
\begin{itemize}[label=--]
	\item гость может выполнять SELECT для всех таблиц за исключением таблицы пользователей, INSERT для таблицы пользователей;
	\item авторизованный пользователь может выполнять SELECT для всех таблиц, INSERT и DELETE для таблицы мероприятий пользователей, UPDATE для таблицы пользователей;
	\item администратор имеет все права доступа.
\end{itemize}

\section{Формализация мероприятия}

Мероприятие рассматривается как система, состоящая из участников, дней, предметов (например, еды), меню и других элементов. 

\subsection{Определение мероприятия}

\textit{Множеством участников} называется группа людей, участвующих в мероприятии и обозначается:
\begin{equation}
	P = \{p_1, p_2, \dots, p_m\}
\end{equation}
где $m$ -- общее количество участников.

\textit{Множеством дней} называются временные интервалы, на которые разбито мероприятие и обозначается:
\begin{equation}
	D = \{d_1, d_2, \dots, d_n\}
\end{equation}
где $n$ -- общее количество дней.

\textit{Общим множеством предметов} называется набор материальных ресурсов необходимых для проведения и обозначается:
\begin{equation}
	O = \{o_1, o_2, \dots, o_k\}
\end{equation}
где $k$ -- общее количество предметов.

\textit{Общим множеством меню} называется множество наборов предметов  и обозначается:
\begin{equation}
	M = \{m_1, m_2, \dots, m_p\}
\end{equation}
где $\forall m_i \in M: m_i \subseteq O$ и $p$ -- общее количество меню.

\textit{Множеством меню} называется множество наборов предметов, привязанных к конкретным дням и обозначается:
\begin{equation}
	DM = \{(d, m): (d, m) \in D \times M\}
\end{equation}
где $d \in D$ -- день мероприятия, $m \in M$ -- меню, соответствующее этому дню и $\forall d \in D \ \exists! m \in M: (d, m) \in DM$.

\textit{Множеством посещений} называется множество связей участников с днями их присутствия и обозначается:
\begin{equation}
	PD = \{(p, c): (p, c) \in P \times 2^D \}
\end{equation}
где $p \in P$ -- участник, $c \in 2^D$ -- подмножество дней, которые участник $p_i$ планирует посетить, и $\forall p \in P \ \exists! c \in 2^D: (p, c) \in PD$.

\textit{Мероприятием} называется кортеж, объединяющий все перечисленные множества и обозначается:
\begin{equation}
	E = (P, D, O, M, PD, DM)
\end{equation}

\subsection{N-мерные случаи}

\textit{Одномерным случаем} называется ситуация выбора участником $p \in P$ ровно одного дня для посещения мероприятия, то есть:
\begin{equation}
	p \in P \ \exists! (p, c) \in PD: |c| = 1
\end{equation}

\textit{Общим одномерным случаем} называется ситуация выбора всеми участниками $p \in P$ ровно одного дня для посещения мероприятия, то есть:
\begin{equation}
	\forall p \in P \ \exists! (p, c) \in PD: |c| = 1
\end{equation}

\textit{$N$-мерным случаем} называется ситуация выбора участником $p \in P$ ровно $n$ дней для посещения мероприятия, то есть:
\begin{equation}
	p \in P \ \exists! (p, c) \in PD: |c| = n
\end{equation}

\textit{Общим $n$-мерным случаем} называется ситуация выбора всеми участниками $p \in P$ от 1-го до $n$ дней для посещения мероприятия, то есть:
\begin{equation}
	\forall p \in P \ \exists! (p, c) \in PD: |c| \in \{1, \dots, n\}
\end{equation}

Из определения следует, что общий одномерный случай является подмножеством общего $n$-мерного случая.

\subsection{Базис мероприятия}

\textit{Базисом мероприятия} называется множество функций, обрабатывающих его.

Функции базиса можно классифицировать следующим образом:
\begin{enumerate}
	\item первого порядка -- функции, рассматривающие одномерный случай;
	\item $n$-го порядка -- функции, рассматривающие $n$-мерный случай.
\end{enumerate}

Из определения следует, что функции первого порядка являются подмножеством функций $n$-го порядка.

\subsubsection{Функции стоимости}

\textit{Функцией стоимости C} называется функция, ставящая своему объекту-аргументу в соответствие его денежную стоимость. Областью определения функции $C$ является $D(C) = E \cup D \cup M \cup O$, а областью значений $E(C) = \mathbb{R}_{\ge 0}$.

\textit{Функция стоимости предмета} обозначается как:
\begin{equation}
	C_O: O \rightarrow \mathbb{R}_{\ge 0}
\end{equation}

\textit{Функция стоимости меню} обозначается как $C_M: M \rightarrow \mathbb{R}_{\ge 0}$ и определяется как сумма всех стоимостей предметов, входящих в меню:
\begin{equation}
	C_M(m) = \sum_{o_i \in m} C_O(o_i)
\end{equation}

\textit{Функция стоимости дня первого порядка} обозначается как \newline $C_D: D \rightarrow \mathbb{R}_{\ge 0}$ определяется как стоимость меню, соответствующего этому дню:
\begin{equation}
	C_D(d) = C_M(m), \ \text{где} \ (d, m) \in DM
\end{equation}

\textit{Функция стоимости дня $n$-го порядка} обозначается как $C_D: D^n \rightarrow \mathbb{R}_{\ge 0}$ \newline и определяется как сумма всех стоимостей меню, соответствующих \newline набору-аргументу из $n$ дней:
\begin{equation}
	C_D(d_1, \dots, d_n) = \sum_{d_i \in \{d_1, \dots, d_n\}}{C_M(m)}, \ \text{где} \ (d_i, m) \in DM
\end{equation}

\textit{Функция стоимости мероприятия} обозначается как $C_E: E \rightarrow \mathbb{R}_{\ge 0}$ определяется как сумма стоимостей всех дней мероприятия:
\begin{equation}
	C_E(E) = \sum_{d_i \in D} C_D(d_i)
	\label{eq:cost-event}
\end{equation}

Функция стоимости определяется как:
\begin{equation}
	C(X) = 
	\begin{cases}
		C_O(X), & X \in O \\
		C_M(X), & X \in M \\
		C_D(X), & X \subseteq D \\
		C_E(X), & X \in E
	\end{cases}
\end{equation}

\subsubsection{Функции цены}

\textit{Функцией цены P} называется функция, ставящая своему объекту-аргументу в соответствие цену его посещения участником $p \in P$. Областью определения функции $P$ является $D(P) = E \cup D$, а областью значений $E(P) = \mathbb{R}_{\ge 0}$.

\textit{Функция цены дня первого порядка} обозначается как:
\begin{equation}
	P_D: D \rightarrow \mathbb{R}_{\ge 0}
\end{equation}

\textit{Функция цены дня n-го порядка} обозначается как:
\begin{equation}
	P_D: D^n \rightarrow \mathbb{R}_{\ge 0}
\end{equation}

Функция цены мероприятия обозначается как $P_E: E \rightarrow \mathbb{R}_{\ge 0}$ определяется как сумма цен посещения всех его дней:
\begin{equation}
	P_E(E) = \sum_{d_i \in D}{P_D(d_i)}
\end{equation}

Функция цены определяется как:
\begin{equation}
	P(X) = 
	\begin{cases}
		P_D(X), & X \subseteq D \\
		P_E(X), & X \in E
	\end{cases}
\end{equation}

\subsubsection{Вспомогательные функции}

\textit{Функция текущих комбинаций дней} обозначается как $H: E \rightarrow 2^D$ и определяется как множество текущих комбинаций дней $c \in 2^D$, выбранных участниками $P$:
\begin{equation}
	H(E) = \{c: p \in P \ \exists c: (p, c) \in PD\}
\end{equation}

\textit{Функция количества человек конкретного дня первого порядка} обозначается как $N_D: D \rightarrow \mathbb{N}$ и определяется как мощность множества участников конкретного дня:
\begin{equation}
	N(d) = |\{p: (p, d) \in PD\}|
\end{equation}

\textit{Функция количества человек конкретного дня n-го порядка} обозначается как $N_D: D^n \rightarrow \mathbb{N}$ и определяется как мощность множества участников конкретного набора из $n$ дней:
\begin{equation}
	N(d_1, \dots, d_n) = |\{p: (p, \{d_1, \dots, d_n\}) \in PD\}|
\end{equation}

\textit{Функцией количества человек мероприятия} обозначается как \newline $N_E: E \rightarrow \mathbb{N}$ и определяется как сумма количества человек на каждой из текущих комбинаций дней:
\begin{equation}
	N_E(E) = \sum_{c_i \in H(E)}{N_D(c_i)}
\end{equation}

\textit{Функция коэффициента дня первого порядка} обозначается как \newline $A: D \rightarrow \mathbb{R}_{\ge 0}$ и определяется как отношение стоимости дня к минимальной стоимости:
\begin{equation}
	A(d) = \frac{C_D(d)}{\min_{d_i \in D}{C_D(d_i)}}
\end{equation}

\textit{Функция коэффициента дня n-го порядка} обозначается как \newline $A: D^n \rightarrow \mathbb{R}_{\ge 0}$ и определяется как сумма отношений стоимости каждого дня из набора к минимальной стоимости:
\begin{equation}
	A(d_1, \dots, d_n) = \frac{1}{\min_{d_i \in D}{C_D(d_i)}}\sum_{d_i \in \{d_1, \dots, d_n\}}{C_D(d_i)}
\end{equation}

\subsection{Уравнения баланса}

\subsubsection{Общий одномерный случай}

Чтобы все расходы на конкретный день были покрыты, необходимо, чтобы доходы от участников этого дня были им равны:
\begin{equation}
	C_D(d) = P_D(d) \cdot N(d)
	\label{eq:cost-price-1}
\end{equation}

Из определения~\ref{eq:cost-event} и уравнения~\ref{eq:cost-price-1} имеем:
\begin{equation}
	C_E(E) = \sum_{d_i \in D} C_D(d_i) = \sum_{d_i \in D}{P_D(d_i) \cdot N(d_i)}
	\label{eq:balance-equation-1}
\end{equation}

\subsubsection{Общий n-мерный случай}

Чтобы все расходы на конкретную комбинацию дней были покрыты, необходимо, чтобы доходы от участников этой комбинации были им равны:
\begin{equation}
	C_D(d_1, \dots, d_n) = P_D(d_1, \dots, d_n) \cdot N(d_1, \dots, d_n)
	\label{eq:cost-price-2}
\end{equation}

В $n$-мерном случае участники оплачивают присутствие не на конкретных днях, а на их комбинациях, потому, чтобы покрыть расходы на всё мероприятие, необходимо покрыть расходы на все комбинации:
\begin{equation}
	C_E(E) = \sum_{c_i \in H(E)}{P_D(c_i) \cdot N(c_i)}
	\label{eq:balance-equation-2}
\end{equation}

Уравнения~\ref{eq:balance-equation-1} и~\ref{eq:balance-equation-2} называются \textit{уравнениями баланса} для общих одномерного и $n$-мерного случаев соответственно.

\subsection{Фундаментальная цена}

Фундаментальная цена -- это константная базовая цена, которая используется для расчета цены посещения каждого дня мероприятия. Она определяется таким образом, чтобы общая выручка от участников покрывала все затраты на проведение мероприятия. Цена посещения дня выражается через фундаментальную цену $P_0$ и коэффициент дня:
\begin{itemize}[label=--]
	\item для одномерного случая:
	\begin{equation}
		P_D(d) = A(d) \cdot P_0
		\label{eq:price-by-fundamental-price-1}
	\end{equation}
	\item для $n$-мерного случая:
	\begin{equation}
		P_D(d_1, \dots, d_n) = A(d_1, \dots, d_n) \cdot P_0
		\label{eq:price-by-fundamental-price-2}
	\end{equation}
\end{itemize}  

\subsubsection{Общий одномерный случай}

Подставив уравнение~\ref{eq:price-by-fundamental-price-1} в уравнение~\ref{eq:cost-price-1}, имеем:
\begin{equation}
	C_D(d) = A(d) \cdot P_0 \cdot N(d)
	\label{eq:cost-by-fundamental-1}
\end{equation}

Подставив уравнение~\ref{eq:cost-by-fundamental-1} в уравнение баланса~\ref{eq:balance-equation-1}, имеем:
\begin{equation}
	C_E(E) = \sum_{d_i \in D}{A(d_i) \cdot P_0 \cdot N(d_i)} = P_0 \cdot \sum_{d_i \in D}{A(d_i) \cdot N(d_i)}
	\label{eq:balance-equation-by-fundamental-1}
\end{equation}

Из уравнения~\ref{eq:balance-equation-by-fundamental-1} имеем:
\begin{equation}
	P_0 = \frac{C_E(E)}{\sum_{d_i \in D}{A(d_i) \cdot N(d_i)}}
	\label{eq:fundamental-price-1}
\end{equation}

\subsubsection{Общий n-мерный случай}

Подставив уравнение~\ref{eq:price-by-fundamental-price-2} в уравнение~\ref{eq:cost-price-2}, имеем:
\begin{equation}
	C_D(d_1, \dots, d_n) = A(d_1, \dots, d_n) \cdot P_0 \cdot N(d_1, \dots, d_n)
	\label{eq:cost-by-fundamental-2}
\end{equation}

Подставив уравнение~\ref{eq:cost-by-fundamental-2} в уравнение баланса~\ref{eq:balance-equation-2}, имеем:
\begin{equation}
	C_E(E) = \sum_{c_i \in H(E)}{A(c_i) \cdot P_0 \cdot N(c_i)} = P_0 \cdot \sum_{c_i \in H(E)}{A(c_i) \cdot N(c_i)}
	\label{eq:balance-equation-by-fundamental-2}
\end{equation}

Из уравнения~\ref{eq:balance-equation-by-fundamental-2} имеем:
\begin{equation}
	P_0 = \frac{C_E(E)}{\sum_{c_i \in H(E)}{A(c_i) \cdot N(c_i)}}
	\label{eq:fundamental-price-2}
\end{equation}

\section{Используемые триггеры}

\section{Архитектура приложения}

\subsection{Диаграмма потока данных}

\subsection{Диаграмма компонентов}

\subsection{Диаграмма классов}


\section{Вывод}

В конструкторской части работы были представлены требования к программе, 

\clearpage
